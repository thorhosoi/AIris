# プロジェクトAiris知識ベース

このドキュメントは、2025年10月13日時点での「Airis」プロジェクトの現在の状態と理解をまとめたものです。コンテキストの維持とプロジェクトの進化の追跡のための包括的な知識リポジトリとして機能します。

**注意:** これはライブドキュメントであり、プロジェクトに関する新しい情報が利用可能になったり、その状態が変化したりするにつれて継続的に更新されます。また、トラブルシューティング手順の繰り返しを避けるために、重要な環境と手順のメモも記録します。

## 1. プロジェクト概要

- **プロジェクト名:** `Airis`
- **コンセプト:** 自己進化するAIワーカーフォースプラットフォーム。会話型CLIを通じてユーザーから複雑で高レベルのタスクを受け取り、自律的なAIエージェントのチームが協力して解決するために分解します。
- **主要目標:** 複雑な知的タスクを自動化することで、開発者とSREの生産性を劇的に向上させ、人間がより創造的な仕事に集中できるようにします。
- **初期ターゲット:** IaCを介したクラウドインフラストラクチャのプロビジョニングなど、SRE/DevOpsタスクの自動化。

## 2. 中核アーキテクチャとコンセプト

- **IACT（Interactive Agents Call Tree）:** これが中核アーキテクチャです。メインオーケストレーターがユーザーのリクエストを階層的なタスクツリーに分解します。ツリー内の各ノードは専門のAIエージェントに割り当てられます。エージェントは通信して協力してタスクを完了できます。
- **動的エージェント生成:** システムは、タスクの要件に基づいて必要なエージェント（コーディング、シェル実行、ウェブ検索など）を動的に起動できます。
- **自己拡張:** 重要な長期機能。Airisは新しいツールの必要性を特定し、そのコードを書き、テストし、自身の機能に統合できます。
- **サンドボックス環境:** すべてのコードとシェルコマンドは、ホストシステムを保護するために安全で分離されたDockerコンテナ内で実行されます。これは重要な安全機能です。
- **ユーザーインザループ:** 安全性と制御のために、システムは潜在的に破壊的または不可逆的なアクション（シェルコマンドの実行やファイルの上書きなど）を実行する前にユーザーの承認を求めます。

## 3. MVP（最小実行可能製品）スコープ

MVPの目標は、中核的なユーザーエクスペリエンスを検証することです：ユーザーが指示を出し、Airisが安全にコード/コマンドを実行してファイルベースの成果物を生成します。

- **インターフェース:** コマンドラインインターフェース（CLI）
- **中核エージェント:**
    - `コードエージェント`: Pythonコードを書き、実行する
    - `シェルエージェント`: シェルコマンドを実行する
- **主要ワークフロー:**
    1. ユーザーが指示を提供（例：「フィボナッチのPython関数を書いて」）
    2. `オーケストレーター`がタスクを計画
    3. `コードエージェント`がPythonコードを記述
    4. `オーケストレーター`がファイル保存のユーザー承認を求め、**タスクと生成されたコードに基づいてファイル名を提案**
    5. ユーザーの承認後、ファイルがローカルファイルシステムの**専用出力ディレクトリ（例：`generated_scripts/`）に保存**
- **MVPスコープ外:** 自己拡張、ウェブブラウジング、マルチモーダル機能、GUI

## 4. 技術スタック

- **言語:** Python 3.11+
- **CLIフレームワーク:** Typer
- **AI/エージェントフレームワーク:** LangChain（オーケストレーターとエージェントの実装に重要なライブラリ）
- **サンドボックス:** Docker（Python用Docker SDKで管理）
- **設定:** PyYAML（`config.yaml`）
- **環境変数:** `python-dotenv`（`.env`ファイルの読み込み用）
- **テスト:** `pytest`（ユニットテストと統合テスト用）

## 5. プロジェクトファイル構造と主要コンポーネント

- **`airis/main.py`**: Typerで構築されたCLIエントリーポイント。ユーザー入力をキャプチャしてオーケストレーターに渡します。
- **`airis/orchestrator.py`**: アプリケーションの「脳」。メインIACTロジックを収容し、ユーザーリクエストを解釈し、エージェントを調整します。
- **`airis/llm.py`**: Claude、GPTなどの大規模言語モデル（LLM）との通信を抽象化するクライアント。LangChainのラッパーを使用。
- **`airis/sandbox.py`**: Dockerサンドボックスのライフサイクルを管理。コンテナの作成、内部でのコマンド実行、その後削除を担当。
- **`agents/`**: 専門エージェント用のディレクトリ
    - `base.py`: すべてのエージェントの抽象基底クラス
    - `code_agent.py`: コードの記述と実行を担当するエージェント
    - `shell_agent.py`: シェルコマンドの実行を担当するエージェント
- **`Dockerfile` / `docker-compose.yml`**: 開発と実行環境を定義
- **`config.yaml.example`**: ユーザーがLLMモデル、APIキーなどを定義できるサンプル設定ファイル
- **`requirements.txt`**: Python依存関係をリスト
- **`tests/`**: ユニットテストと統合テスト用のディレクトリ
    - `test_orchestrator.py`: オーケストレーターの委譲ロジックのユニットテスト

## 6. 開発環境メモ

- **コンテナユーザー:** 開発を簡素化し、Dockerソケット権限の問題を回避するため、メインコンテナは現在`root`ユーザーとして実行されています。これはセキュリティ上理想的ではなく、将来より安全なソリューション（例：GIDマッチング）を実装するために再検討する必要があります。
- **Git状態の不一致:** AIの実行環境がユーザーの環境とは異なる`git status`を表示する持続的な問題が発生しました。`git add .`や`git add -A`などの標準コマンドは、ファイルが存在するにもかかわらず、AI用に新しいファイルをステージングできませんでした。根本原因は、AIのツール環境とユーザーのファイルシステム状態の間の同期問題のようです。
- **解決策:** ユーザーが手動でファイルをステージングする必要がありました。将来、`git`コマンドが予期しない結果を生成する場合は、この状態の不一致が発生していると仮定し、`git`操作についてはユーザーに委ねるか、`rm .git/index`を試してGitに完全な再スキャンを強制してください。
- **Curses TUI不安定性:** シンプルなCLIをPythonの`curses`ライブラリを使用したより高度なテキストベースユーザーインターフェース（TUI）に置き換える試みが行われました。これは、`cbreak() returned ERR`と`nocbreak() returned ERR`エラーで繰り返し失敗しました（`curses.wrapper`の使用、手動セットアップなど、様々な実装戦略で）。根本原因は、`curses`ライブラリとAIの`run_shell_command`ツールによって提供されるターミナル環境の間の非互換性が疑われます。これは完全機能のTTYではない可能性があります。
- **決定:** `curses` TUIの開発は無期限に延期されます。プロジェクトは既存のCLIで継続し、MVP要件で概説された中核機能の強化に焦点を当てます。
- **サンドボックス用HOST_PROJECT_DIR:** Dockerコンテナ内で`Airis`を実行する場合、`airis/sandbox.py`モジュールはネストされたDockerコンテナを作成する必要があります。これらの子サンドボックスコンテナにホストのプロジェクトディレクトリを正しくマウントするために、`HOST_PROJECT_DIR`環境変数（`docker-compose.yml`で`${PWD}`に設定）が利用されます。これにより、`sandbox`がバインドマウント用にホストの絶対パスを正しく参照できるようになります。
- **Dockerインタラクティブモード不安定性:** `docker attach`を使用してDockerコンテナ内で実行されている`Airis`とのインタラクティブセッションを有効にする試みが行われました。これは、`docker-compose.yml`で`tty: true`と`stdin_open: true`を設定しても、`the input device is not a TTY`エラーで繰り返し失敗しました。これは、`run_shell_command`環境が`docker attach`が正しく機能するために必要なインタラクティブTTYセッションを完全にエミュレートできないことを示しています。
- **決定:** Dockerコンテナ内での`Airis`のインタラクティブモードは無期限に延期されます。プロジェクトは、Dockerで実行される`Airis`の単一コマンド実行モデルで継続します。

## 7. 現在実装されている機能

### 中核機能
- **CLIインターフェース:** 会話型AIによるコマンドラインプロンプトでのユーザー対話
- **マルチエージェントアーキテクチャ:** 異なるタスクタイプ用の専門エージェント
- **AIエンジン選択システム:** タスク要件に基づくAIエンジンの動的選択
- **プロジェクト管理:** 自動ドキュメント生成による完全なプロジェクトライフサイクル管理
- **Dockerサンドボックス:** すべてのコードとコマンドの安全な実行環境
- **Git統合:** インテリジェントなコミットメッセージによる自動バージョン管理

### 専門エージェント
- **コードエージェント:** DockerサンドボックスでPythonコードを生成・実行
- **シェルエージェント:** Dockerサンドボックスでシェルコマンドを生成・実行
- **ウェブ検索エージェント:** DuckDuckGo APIを使用したウェブ検索の実行
- **ウェブブラウザエージェント:** URLからのコンテンツ取得と要約
- **Cursorエージェント:** 高度なコード生成のためのCursorエディタ統合
- **Geminiエージェント:** コード分析とドキュメント改善のためのGoogle Gemini API活用
- **Gitエージェント:** すべてのgit操作（add、commit、push、status）の処理
- **ドキュメント完成エージェント:** 不完全なドキュメントの自動チェックと完成

### 高度な機能
- **マルチ言語サポート:** 日本語と英語のドキュメント生成
- **インテリジェントタスクルーティング:** AI駆動のタスク分類とエージェント選択
- **コンプライアンスモード:** 制限されたAIエンジン使用による企業ポリシーコンプライアンス
- **コスト最適化:** コスト効率のためのタスク複雑度ベースのエンジン選択
- **ドキュメント品質保証:** 自動完全性チェックと完成
- **クロスプラットフォーム互換性:** Windows、macOS、Linuxで動作
- **包括的テスト:** 自動化されたテストと手動テストフレームワーク

## 8. 最近のトラブルシューティングと解決策（2025年10月13日）

このセクションでは、2025年10月13日の開発セッション中に遭遇した問題とその解決策を詳述します。

### 8.1. `airis/orchestrator.py`の`SyntaxError: unterminated string literal`

- **問題:** `airis/orchestrator.py`ファイルに、文字列リテラル内の余分な二重引用符とバックスラッシュによる26行目の`SyntaxError`が含まれており、アプリケーションが正しく起動できませんでした。
- **解決策:** `airis/orchestrator.py`の文字列リテラルから余分な文字を削除しました。

### 8.2. `tests/test_orchestrator.py`の`AssertionError`

- **問題:** `orchestrator.py`の`SyntaxError`を修正した後、2つのユニットテスト（`test_orchestrator_delegates_to_code_agent`と`test_orchestrator_defaults_to_code_agent`）が`AssertionError`で失敗しました。これは、`orchestrator.delegate_task`メソッドがタプル`(display_result, generated_code)`を返すように変更されたにもかかわらず、テストがまだ最初の要素（`result[0]`）ではなく、`result`タプル全体に対してアサーションしていたためです。
- **解決策:** `tests/test_orchestrator.py`の失敗したアサーションを更新して、期待される文字列に対して`result[0]`を正しくチェックするようにしました。

### 8.3. CodeAgent実行中の`SyntaxError`（Markdown区切り文字）

- **問題:** `develop`コマンドを実行する際、`CodeAgent`が`SyntaxError: invalid syntax`で失敗しました。これは、LLMの出力にMarkdownコードブロック区切り文字（例：```python）が含まれており、これらが正しく削除されず、実行可能なPythonファイルに書き込まれていたためです。
- **解決策:** `agents/code_agent.py`を修正して、生成されたコードの先頭と末尾から```python`と``` `区切り文字を削除するため、より堅牢で直接的な文字列操作アプローチを使用するようにしました。

### 8.4. CodeAgent実行中の`SyntaxError` / `IndentationError`（不正なLLM出力）

- **問題:** Markdown区切り文字の削除を修正した後も、`CodeAgent`が時々`SyntaxError: unterminated triple-quoted string literal`または`IndentationError: expected an indented block`に遭遇しました。これは、LLMが不完全または不正なPythonコード（例：閉じられていないdocstring、欠落した関数本体）を生成していたためです。
- **解決策:**
    1. `agents/code_agent.py`のLLMプロンプトを改良して、「完全で構文的に正しいPythonスクリプト」を明示的に要求し、「すべての関数定義と制御フロー文の後にインデントされたブロックが続くことを確認する」ようにしました。
    2. `agents/code_agent.py`で`compile(code, '<string>', 'exec')`を使用してPython構文チェックを実装し、生成されたコードを書き込み・実行する前に無効なコードの実行を防ぎ、構文問題について即座にフィードバックを提供するようにしました。

### 8.5. 成功した`develop`コマンド実行

- **結果:** 上記のすべての修正を適用した後、`develop`コマンドが正常に実行され、要件ドキュメント、設計ドキュメント、およびフィボナッチ数を計算するための構文的に有効で実行可能なPythonスクリプトが生成されました。

## 9. プロジェクト規約と設定

このセクションでは、Airisプロジェクトの確立された規約とユーザー設定を概説します。

### 9.1. プロジェクト命名規約

- **規約:** `[YYYYMMDD]-[project-purpose-in-kebab-case]`
- **説明:** Airisを使用して新しいプロジェクトを作成する際、プロジェクト名はこの形式に従う必要があります。作成日（YYYYMMDD）で始まり、その後にケバブケース（小文字、ハイフン区切り）での説明的な目的が続きます。これにより、一貫性、明確性、マシンフレンドリーさが確保されます。
- **例:** `20251013-fibonacci-calculator`

### 9.2. ドキュメント言語

- **設定:** 日本語（Japanese）
- **説明:** Airisによって生成されるすべてのドキュメント（要件、設計ドキュメント、人間が消費することを目的としたその他のテキスト出力を含む）は日本語である必要があります。

### 9.3. プロジェクト規約

- **ファイル命名:** Pythonファイルにはsnake_case、プロジェクトディレクトリにはkebab-caseを使用
- **ドキュメント:** より良いアクセシビリティのためにすべてのドキュメントは日本語で
- **コードスタイル:** PEP 8ガイドラインに従う
- **テスト:** すべての新機能にユニットテストを含める
- **知識ベース:** このファイルはプロジェクトの中央知識リポジトリとして機能
- **Git管理:** すべてのコード変更は自動的にgitにコミット
- **ドキュメント品質:** 生成されたすべてのドキュメントは完全性がチェックされ、必要に応じて自動完成

## 10. 最近の更新（2025年10月13日）

### 追加された新機能
- **ドキュメント完成エージェント:** 不完全なドキュメントを自動的にチェックし完成
- **Git管理エージェント:** git操作（add、commit、push）を自動的に処理
- **ウェブ検索エージェント:** DuckDuckGoを使用したウェブ検索の実行
- **ウェブブラウザエージェント:** URLからのコンテンツ取得と要約
- **Cursorエージェント:** Cursorエディタ統合による高度なコード生成
- **Geminiエージェント:** コード分析のためのGoogle Gemini API統合
- **日本語ドキュメント:** 生成されるすべてのドキュメントが日本語に
- **自動Gitコミット:** コード変更が自動的にgitにコミット
- **AIエンジン選択システム:** タスク要件に基づく動的AIエンジン選択
- **コンプライアンスモード:** 制限されたAIエンジン使用による企業ポリシーコンプライアンス
- **コスト最適化:** コスト効率のためのタスク複雑度ベースのエンジン選択

### 技術的決定
- **最大トークン数:** APIレート制限を回避するために4000に削減
- **ドキュメント品質:** 完全なドキュメントを確保するための完成チェックを実装
- **Git統合:** すべてのコード変更の自動git操作
- **エラーハンドリング:** git操作とドキュメント生成のエラーハンドリングを改善
- **AIエンジン選択:** 柔軟なAIエンジン選択システムを実装
- **Cursor統合:** より良い品質のためにコード生成をCursorに委譲
- **コンプライアンスモード:** 企業ポリシーコンプライアンス機能を追加
- **コスト最適化:** タスク複雑度ベースのエンジン選択を実装
- **ファイル整理:** プロジェクト構造をクリーンアップし、テストファイルを整理
- **プライバシー保護:** git履歴からすべての個人情報を完全に削除
- **クロスプラットフォームサポート:** より良い移植性のために絶対パスを排除

### アーキテクチャ更新
- **エージェントシステム:** 6つの新しいエージェントを追加（DocumentCompletion、Git、WebSearch、WebBrowser、Cursor、Gemini）
- **オーケストレーター:** インテリジェントタスクルーティングとAIエンジン選択で強化
- **ドキュメント生成:** 日本語ドキュメント用のプロンプトを改善
- **コード実行:** base64エンコーディングアプローチでtemp_code.py問題を修正
- **AIエンジンマネージャー:** インテリジェントエンジン選択システムを追加
- **Cursorエージェント:** コード生成機能で強化
- **設定システム:** YAMLベースの柔軟な設定管理
- **プロジェクト構造:** テストファイルを整理し、不要なファイルをクリーンアップ
- **ドキュメント:** 包括的な日本語READMEと機能ガイドを追加

## 11. AIエンジン選択システム

### 概要
AIエンジン選択システムにより、ユーザーは異なるタスクにどのAIエンジンを使用するかを動的に選択でき、コンプライアンス、コスト最適化、品質要件の柔軟性を提供します。

### 利用可能なエンジン
- **Claude（Anthropic）**: 高品質なコード生成とドキュメント作成
- **Gemini（Google）**: コード分析とドキュメント改善
- **Cursor**: AI支援による専門コード生成
- **ウェブ検索**: リアルタイム情報取得
- **ウェブブラウザ**: URLコンテンツ取得と要約
- **ローカル**: シェルコマンドとgit操作

### 設定モード

#### デフォルトモード
```yaml
ai_engines:
  default_engine: claude
  task_routing:
    code_generation: cursor
    document_generation: claude
    code_analysis: gemini
    web_search: web_search
    web_browsing: web_browser
    git_operations: local
    shell_operations: local
```

#### コンプライアンスモード
```yaml
ai_engines:
  compliance_mode: true
  allowed_engines:
    - gemini
    - local
```

#### コスト最適化モード
```yaml
ai_engines:
  cost_optimization: true
  cost_preferences:
    high_cost: claude
    medium_cost: gemini
    low_cost: web_search
    free: local
```

### コマンドインターフェース
```bash
# 基本設定
ai engine set default <engine_name>
ai engine set task <task_type> <engine_name>

# コンプライアンスモード
ai engine enable compliance [allowed_engines...]
ai engine disable compliance

# コスト最適化
ai engine enable cost optimization
ai engine disable cost optimization

# エンジン管理
ai engine set availability <engine_name> <true/false>
ai engine info
ai engine save
ai engine reset
```

### タスク複雑度評価
システムはキーワードに基づいてタスク複雑度を自動的に評価します：
- **高複雑度**: "complex", "advanced", "sophisticated", "enterprise"
- **中複雑度**: "analysis", "optimize", "improve", "refactor"
- **低複雑度**: "simple", "basic", "quick", "small"

### 使用例
1. **すべてGemini**: すべてのタスクのデフォルトをGeminiに設定
2. **コンプライアンス**: 承認されたエンジンのみに制限
3. **コスト最適化**: 簡単なタスクには最も安いエンジンを使用
4. **コード生成のみCursor**: コード生成のみにCursorを使用
5. **ハイブリッドアプローチ**: 異なるタスクタイプに異なるエンジン

## 12. プロジェクト組織と構造

### 現在のファイル組織
```
AIris/
├── agents/                 # AIエージェント
│   ├── base.py            # 基底クラス
│   ├── code_agent.py      # コード生成エージェント
│   ├── shell_agent.py     # シェルコマンドエージェント
│   ├── web_search_agent.py # ウェブ検索エージェント
│   ├── web_browser_agent.py # ウェブブラウジングエージェント
│   ├── cursor_agent.py    # Cursorエディタ連携エージェント
│   ├── gemini_agent.py    # Gemini API連携エージェント
│   ├── git_agent.py       # Git操作エージェント
│   └── document_completion_agent.py # ドキュメント完成エージェント
├── airis/                  # メインアプリケーション
│   ├── main.py            # CLIエントリーポイント
│   ├── orchestrator.py    # タスクオーケストレーター
│   ├── llm.py             # LLMクライアント
│   ├── sandbox.py         # Dockerサンドボックス管理
│   ├── config.py          # 設定管理
│   ├── ai_engine_manager.py # AIエンジン選択管理
│   └── ai_engine_commands.py # AIエンジンコマンド処理
├── doc/                    # プロジェクトドキュメント
│   ├── 00_PROJECT_PROPOSAL.md
│   ├── 01_REQUIREMENTS_DEFINITION.md
│   ├── 02_SYSTEM_DESIGN.md
│   ├── 03_ARCHITECTURE_UPDATE.md
│   ├── 04_TECHNICAL_SPECIFICATIONS.md
│   ├── 05_CHANGELOG.md
│   ├── 06_TEST_PLAN.md
│   ├── 07_MANUAL_TEST_GUIDE.md
│   ├── 08_MANUAL_TEST_CHECKLIST.md
│   ├── 09_FEATURE_GUIDE.md
│   ├── CONTRIBUTING.md
│   ├── README.md
│   └── TASKS.md
├── test_files/            # テスト関連ファイル
│   ├── run_tests.py       # テスト実行スクリプト
│   ├── manual_test_runner.sh
│   └── test_projects/     # テスト用プロジェクト
├── tests/                 # ユニットテスト
│   ├── __init__.py
│   └── test_orchestrator.py
├── README.md              # 英語版README
├── README_JP.md           # 日本語版README
├── FEATURES.md            # 機能一覧
├── PROJECT_KNOWLEDGE.md   # プロジェクト知識ベース（英語）
├── PROJECT_KNOWLEDGE_JP.md # プロジェクト知識ベース（日本語）
├── config.yaml            # 設定ファイル
├── config.yaml.example    # 設定ファイルサンプル
├── requirements.txt       # Python依存関係
├── Dockerfile             # Dockerイメージ定義
├── docker-compose.yml     # Docker Compose設定
└── .gitignore             # Git除外設定
```

### 実施された主要改善
- **ファイルクリーンアップ**: 不要なファイル（fibonacci.py、test_api_keys.py、テストレポート）を削除
- **テスト整理**: すべてのテストファイルをtest_files/ディレクトリに移動
- **プロジェクト構造**: テストプロジェクトをtest_files/test_projects/下に整理
- **ドキュメント**: 包括的な日本語READMEと機能ガイドを追加
- **プライバシー保護**: git履歴からすべての個人情報を完全に削除
- **クロスプラットフォームサポート**: より良い移植性のために絶対パスを排除
- **Git管理**: より良いテストファイル管理のために.gitignoreを更新

---

**Airis** - 未来のAIワーカーフォースを今日から始めましょう。
