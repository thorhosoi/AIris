# `Airis` MVP 要件定義書 v1.2

| 項目 | 内容 |
| --- | --- |
| **ドキュメントバージョン** | 1.2 |
| **作成日** | 2025年10月11日 |
| **更新日** | 2025年10月12日 |
| **対象フェーズ** | MVP (Minimum Viable Product) |
| **目標** | 対話形式で指示を受け、安全な環境でコード/コマンドを実行し、ファイルとして成果物を生成するコア体験の実現 |

---

## 1. 機能要件 (Functional Requirements)

### FR-1: 対話型インターフェース (CLI)
ユーザーが`Airis`を操作するための主要なインターフェースを定義する。

- **FR-1.1: 起動とプロンプト**
  - ユーザーはターミナルで `airis` コマンドを実行してアプリケーションを起動する。
  - 起動後、`Airis`はバージョン情報などのウェルカムメッセージを表示し、ユーザーの入力を促すプロンプト（例: `> `）を表示して待機状態に入る。

- **FR-1.2: マルチターン対話**
  - ユーザーはプロンプトに対して自然言語で指示を入力する。
  - `Airis`は指示が不明確な場合、追加の質問をすることでタスク内容を明確化する。
  - ユーザーは `exit` または `quit` コマンドでセッションを終了できる。

### FR-2: 成果物のファイル出力
タスク実行の結果として生成されるコンテンツの取り扱いを定義する。

- **FR-2.1: ログのリアルタイム表示**
  - `Airis`の思考プロセス（どのエージェントを呼び出すかなど）や実行中の処理状況は、ログとしてターミナルにリアルタイムでストリーミング表示される。

- **FR-2.2: ファイルへの保存**
  - コードスニペットや設定ファイルなどの最終的な生成物は、ファイルとして出力される。
  - **保存先は、`config.yaml`で指定された専用の出力ディレクトリ（デフォルトは`generated_scripts/`）とする。**

- **FR-2.3: ファイル名の決定**
  - `Airis`は対話の文脈から適切なファイル名（例: `main.tf`, `fibonacci.py`）を推論し、ユーザーに提案する。
  - ユーザーは提案されたファイル名を承認、または別の名前を指定できる。
  - **進捗: 完了**

### FR-3: ユーザー承認ステップ
システムの安全性と意図しない動作を防ぐための確認メカニズムを定義する。

- **FR-3.1: 承認トリガー**
  - 以下の操作を実行する前には、必ずユーザーの承認を求める。
    - 既存のファイルへの上書き
    - シェルコマンドの実行
    - （将来的に）高コストが予想されるAPIコール

- **FR-3.2: 承認プロンプト**
  - 承認を求める際は、実行しようとしている操作の内容を明記した上で、「実行しますか？ (y/n)」といった明確な問いかけを表示する。
  - ユーザーが `n` を選択した場合、その操作はキャンセルされ、`Airis`は代替案を検討またはユーザーに次の指示を求める。
  - **進捗: 完了**

### FR-4: 自動リトライ機能
タスク失敗時の回復性を高めるための挙動を定義する。

- **FR-4.1: リトライ条件**
  - 生成したコードの構文エラーや、実行したコマンドがエラーコードで終了した場合など、プログラム的に検知可能な失敗が発生した場合にリトライを行う。

- **FR-4.2: リトライ処理**
  - リトライは一度だけ自動で試行する。
  - 再試行の際には、一度目の失敗原因（エラーメッセージなど）を考慮して、異なるアプローチを試みる。

- **FR-4.3: 最終的な失敗**
  - リトライしてもタスクが成功しなかった場合、失敗した原因を要約したエラーメッセージをユーザーに提示して処理を終了する。

---

## 2. 非機能要件 (Non-Functional Requirements)

### NFR-1: ポータビリティ (実行環境)
様々な環境で`Airis`を動作させるための要件を定義する。

- **NFR-1.1: 動作環境**
  - ホストOSとしてmacOS, Windows (WSL2), Linuxをサポートする。

- **NFR-1.2: 必須コンポーネント**
  - ホストOS上での**Docker**のインストールおよび実行を必須要件とする。

- **NFR-1.3: 配布形式**
  - `Dockerfile`および`docker-compose.yml`を提供し、ユーザーが自身の環境で容易にコンテナをビルド・実行できるようにする。

### NFR-2: サンドボックス環境 (セキュリティ)
安全にコードやコマンドを実行するための隔離環境を定義する。

- **NFR-2.1: 実行コンテナ**
  - ユーザーからの指示でコードやコマンドを実行する際は、都度、隔離された一時的なDockerコンテナを起動してその中で処理を行う。

- **NFR-2.2: ネットワーク**
  - 実行コンテナは、外部インターネットへのアウトバウンドHTTPS通信を許可する（ライブラリのダウンロードやAPIアクセスを可能にするため）。
  - インバウンド通信は原則として許可しない。

- **NFR-2.3: ファイルシステム**
  - ホストOSのカレントディレクトリを、実行コンテナ内の特定の作業ディレクトリにマウントし、ファイルの読み書きを可能にする。

### NFR-3: 設定のカスタマイズ性
ユーザーが`Airis`の挙動を調整するための設定項目を定義する。

- **NFR-3.1: 設定ファイル**
  - `config.yaml` などの人間が読み書きしやすい形式の設定ファイルを提供する。
  - アプリケーションは起動時にこのファイルを読み込む。

- **NFR-3.2: 設定項目**
  - 少なくとも以下の項目を設定ファイルで変更可能とする。
    - `llm_provider`: (例: `anthropic`, `openai`)
    - `model_name`: (例: `claude-3-sonnet-20240229`)
    - `max_api_calls_per_task`: 1タスクあたりのAPIコール上限数（整数）
    - `api_key`: LLMのAPIキー（環境変数からの読み込みを優先する）
    - **`script_output_dir`**: 生成されたスクリプトの保存先ディレクトリ（デフォルト: `generated_scripts`）

---

## 3. MVP受け入れ基準 (Acceptance Criteria)

MVP開発の完了を判断するための、具体的な動作検証シナリオを定義する。

### シナリオ1: IaCコード生成
- **Given:** ユーザーが `airis` を起動し、プロンプトが表示されている。
- **When:** ユーザーが「AWSでt2.microのEC2を立てるTerraformコードを書いて」と指示する。
- **Then:**
  1. `Airis`は `main.tf` というファイル名で保存することを提案し、ユーザーに承認を求める。
  2. ユーザーが `y` を入力すると、AWSの東京リージョンを指定した、構文的に正しいTerraformコードが記述された `main.tf` ファイルが**`script_output_dir`で指定されたディレクトリ内**に作成される。
  3. ターミナルに「タスクが完了しました: `[script_output_dir]/main.tf` を作成しました」といった成功メッセージが表示される。

### シナリオ2: 汎用コード生成
- **Given:** ユーザーが `airis` を起動し、プロンプトが表示されている。
- **When:** ユーザーが「フィボナッチ数を計算するPython関数を書いて」と指示する。
- **Then:**
  1. `Airis`は `fibonacci.py` というファイル名で保存することを提案し、ユーザーに承認を求める。
  2. ユーザーが `y` を入力すると、実行可能なPython関数が記述された `fibonacci.py` ファイルが**`script_output_dir`で指定されたディレクトリ内**に作成される。
  3. ターミナルに「タスクが完了しました: `[script_output_dir]/fibonacci.py` を作成しました」といった成功メッセージが表示される。
