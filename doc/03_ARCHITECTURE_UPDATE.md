# Airis アーキテクチャ更新ドキュメント

## バージョン情報

| 項目 | 内容 |
|------|------|
| 更新日 | 2025-10-13 |
| バージョン | 2.2.0 |
| 更新者 | AIris Development Team |

---

## 1. 概要

本ドキュメントは、AirisプロジェクトのPhase 2機能拡張におけるアーキテクチャ更新について記録します。新機能の追加、既存機能の改善、技術的決定事項を包括的に文書化しています。

## 2. 新機能追加

### 2.1 AIエンジン選択システム

**目的**: ユーザーがAIエンジンを自由に選択し、コンプライアンスやコスト最適化に対応する

**実装詳細**:
- **ファイル**: `airis/ai_engine_manager.py`, `airis/ai_engine_commands.py`
- **機能**:
  - 動的エンジン選択（タスクタイプ、複雑度、コンプライアンスに基づく）
  - コンプライアンスモード（企業ポリシーに基づくエンジン制限）
  - コスト最適化モード（タスク複雑度に応じた自動選択）
  - エンジン可用性チェック
  - 設定の永続化

**コマンドインターフェース**:
- `ai engine set default <engine_name>`
- `ai engine enable compliance [allowed_engines...]`
- `ai engine enable cost optimization`
- `ai engine info`

### 2.2 Cursor統合強化

**目的**: コード生成の品質向上とCursorとの統合

**実装詳細**:
- **ファイル**: `agents/cursor_agent.py`（拡張）
- **機能**:
  - コード生成機能の追加
  - macOSパスの自動検出
  - 一時ファイル作成とCursorでの開封
  - AIチャットの使用方法案内

**キーワードルーティング**:
- `code`, `python`, `program`, `script`, `write`, `create`, `generate`

### 2.3 Web検索エージェント

**目的**: ユーザーの質問に対してWeb検索を実行し、結果を要約して提供する

**実装詳細**:
- **ファイル**: `agents/web_search_agent.py`
- **依存関係**: `duckduckgo-search`
- **機能**:
  - LLMを使用した検索クエリ生成
  - DuckDuckGo APIを使用したWeb検索実行
  - 検索結果の要約と回答生成

**キーワードルーティング**:
- `search`, `find`, `look up`, `web search`

### 2.2 Webブラウジングエージェント

**目的**: 指定されたURLからコンテンツを取得し、要約して提供する

**実装詳細**:
- **ファイル**: `agents/web_browser_agent.py`
- **依存関係**: `requests`, `beautifulsoup4`, `lxml`
- **機能**:
  - URL抽出（正規表現使用）
  - HTTPリクエストによるコンテンツ取得
  - BeautifulSoupによるHTML解析
  - コンテンツの要約生成

**キーワードルーティング**:
- `browse`, `visit`, `url`, `http`, `https`, `website`

### 2.3 ドキュメント完成度チェックエージェント

**目的**: 生成されたドキュメントの完成度をチェックし、未完成の場合は自動的に完成させる

**実装詳細**:
- **ファイル**: `agents/document_completion_agent.py`
- **機能**:
  - ドキュメントの長さチェック
  - 不完全なパターンの検出
  - 必要なセクションの存在確認
  - 適切な終了の確認
  - 自動完成機能

**キーワードルーティング**:
- `complete`, `finish`, `complete doc`, `ドキュメント完成`, `完成`

### 2.4 Git管理エージェント

**目的**: コード変更の自動的なgit管理（add, commit, push）

**実装詳細**:
- **ファイル**: `agents/git_agent.py`
- **機能**:
  - Git状態確認
  - ファイルのステージング
  - 変更のコミット
  - リモートリポジトリへのプッシュ
  - 自動ワークフロー（設定→追加→コミット→プッシュ）

**キーワードルーティング**:
- `git`, `commit`, `push`, `add`, `status`, `git管理`, `コミット`, `プッシュ`

## 3. 既存機能の改善

### 3.1 日本語ドキュメント生成

**変更内容**:
- 全てのドキュメント生成プロンプトを日本語に変更
- 一貫した構成でドキュメント生成
- 技術的内容も分かりやすく説明

**対象ファイル**:
- `airis/orchestrator.py` (ドキュメント生成部分)

### 3.2 コード実行エラーの修正

**問題**: `temp_code.py not found`エラー

**解決方法**:
- Base64エンコーディングを使用したコード実行
- サンドボックス内での直接実行

**対象ファイル**:
- `agents/code_agent.py`

### 3.3 APIレート制限の対応

**問題**: 1分間に8,000トークンのレート制限

**解決方法**:
- max_tokensを16,000から4,000に削減
- ドキュメント完成度チェック機能で品質を確保

**対象ファイル**:
- `airis/llm.py`

## 4. 技術的決定事項

### 4.1 ファイル命名規則

**決定**: `GEMINI.md` → `PROJECT_KNOWLEDGE.md`

**理由**:
- 特定のAIモデル名を含むのは不適切
- プロジェクトの知識ベースであることが明確
- 将来のAIモデル変更にも対応可能

### 4.2 ドキュメント品質管理

**決定**: ドキュメント完成度チェック機能の実装

**理由**:
- LLMの出力が途中で切れる問題の解決
- 一貫した品質のドキュメント生成
- ユーザーエクスペリエンスの向上

### 4.3 Git自動化

**決定**: コード変更時の自動gitコミット

**理由**:
- 開発効率の向上
- 変更履歴の自動管理
- チーム開発での一貫性確保

## 5. アーキテクチャ図

```
┌─────────────────────────────────────────────┐
│                Orchestrator                 │
│  (Keyword-based routing & task delegation)  │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│              Agent System                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │   Code   │ │  Shell   │ │  Cursor  │   │
│  └──────────┘ └──────────┘ └──────────┘   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │WebSearch │ │WebBrowser│ │DocComp.  │   │
│  └──────────┘ └──────────┘ └──────────┘   │
│  ┌──────────┐                             │
│  │   Git    │                             │
│  └──────────┘                             │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│            External Services                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │   LLM    │ │DuckDuckGo│ │  Docker  │   │
│  │ (Claude) │ │   API    │ │ Sandbox  │   │
│  └──────────┘ └──────────┘ └──────────┘   │
└─────────────────────────────────────────────┘
```

## 6. 依存関係の更新

### 6.1 新規依存関係

```txt
duckduckgo-search  # Web検索機能
beautifulsoup4     # HTML解析
lxml              # XML/HTMLパーサー
```

### 6.2 設定ファイル更新

**config.yaml**:
- `max_tokens`: 4000に削減
- `temperature`: 0.1に設定

## 7. テスト結果

### 7.1 機能テスト

| 機能 | ステータス | 詳細 |
|------|------------|------|
| Web検索エージェント | ✅ 正常 | 検索クエリ生成・実行・要約が正常 |
| Webブラウジングエージェント | ✅ 正常 | URL取得・解析・要約が正常 |
| ドキュメント完成度チェック | ✅ 正常 | 未完成ドキュメントの自動完成 |
| Git管理エージェント | ✅ 正常 | 自動コミット・プッシュが正常 |
| 日本語ドキュメント生成 | ✅ 正常 | 全てのドキュメントが日本語で生成 |

### 7.2 統合テスト

- **コード生成 + Git管理**: ✅ 正常
- **ドキュメント生成 + 完成度チェック**: ✅ 正常
- **Web検索 + 要約**: ✅ 正常
- **Webブラウジング + 要約**: ✅ 正常

## 8. 今後の課題

### 8.1 短期課題

1. **Web検索精度の向上**: 検索クエリの最適化
2. **エラーハンドリングの強化**: より詳細なエラーメッセージ
3. **テストカバレッジの拡大**: 新機能の単体テスト追加

### 8.2 長期課題

1. **長期記憶機能**: 過去の対話履歴の保持
2. **自動リトライ機能**: 失敗時の自動再試行
3. **パフォーマンス最適化**: レスポンス時間の短縮

## 9. まとめ

Phase 2の機能拡張により、Airisは以下の能力を獲得しました：

- **Web検索・ブラウジング**: 外部情報の取得と要約
- **ドキュメント品質管理**: 完成度チェックと自動完成
- **Git自動化**: コード変更の自動管理
- **日本語対応**: 完全な日本語ドキュメント生成

これらの機能により、Airisはより実用的で使いやすいAI開発アシスタントとして進化しました。今後の開発では、ユーザーフィードバックを基にさらなる改善を続けていきます。

---

**文書承認**

本アーキテクチャ更新ドキュメントは、プロジェクト関係者の合意のもとで作成されました。

- プロジェクトマネージャー: Airis Development Team
- 技術リード: AIris Architecture Team
- 品質保証担当: AIris QA Team

**文書終了**
