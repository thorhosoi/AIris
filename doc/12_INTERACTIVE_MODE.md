# Airis 対話モード

## バージョン情報

| 項目 | 内容 |
|------|------|
| 作成日 | 2025-10-13 |
| バージョン | 2.2.0 |
| 機能名 | Interactive Conversation Mode |

---

## 1. 概要

Airisの対話モードは、ユーザーとAIが会話を重ねながら要件を詰めていくインタラクティブな機能です。

### 1.1 なぜ対話モードが必要か

**従来の問題点**:
```bash
# ワンライナーで実行
$ echo y | docker-compose run -T --rm airis python3 -m airis.main "計算プログラムを作って"

# 結果: 不明確な要件のまま実行される
# - 足し算？引き算？両方？
# - 引数で渡す？ファイルから読む？
# - エラーハンドリングは？
```

**対話モードの利点**:
```
Airis> interactive 計算プログラムを作って

【分析】
計算プログラムには複数の種類があります。

【確認事項】
1. どの演算を実装しますか？
   A) 四則演算（足し算、引き算、掛け算、割り算）
   B) 足し算のみ
   C) その他（指定してください）

2. 入力方法は？
   A) コマンドライン引数
   B) 対話的に入力を求める
   C) ファイルから読み込む

3. エラーハンドリングは？
   A) 基本的なエラー処理のみ
   B) 詳細なエラーメッセージ
   C) なし

Airis> (対話中) 1はA、2はB、3はBでお願いします

【要件確定】
...
```

---

## 2. 使用方法

### 2.1 対話モードの起動

#### 方法1: 引数なしで起動（推奨）

```bash
# Dockerコンテナに入る
$ docker-compose run --rm airis bash

# 対話モードを起動
$ python3 -m airis.main

# または
$ python3 -m airis.main --interactive
```

#### 方法2: 対話モードフラグ

```bash
$ docker-compose run --rm airis python3 -m airis.main -i
```

### 2.2 基本的な使い方

```
======================================================================
  Airis - Interactive Mode
  対話型AIアシスタント
======================================================================

コマンド:
  'help' - ヘルプを表示
  'interactive <リクエスト>' - 対話モードで要件を詰める
  'quick <リクエスト>' - 即座に実行（従来モード）
  'project create <名前>' - プロジェクトを作成
  'project use <名前>' - プロジェクトを切り替え
  'ai engine info' - AI設定を確認
  'exit' / 'quit' - 終了

現在のプロジェクト: validation_test
======================================================================

Airis [validation_test]> 
```

---

## 3. 対話モードの使用例

### 3.1 計算プログラムの作成

```
Airis> interactive 計算プログラムを作って

======================================================================
対話モードを開始します...
======================================================================

【分析】
計算プログラムを作成するリクエストですが、以下の点を明確にする必要があります。

【確認事項】
1. どの種類の計算を実装しますか？
   A) 四則演算（+, -, *, /）
   B) 足し算のみ
   C) より高度な計算（べき乗、平方根など）
   D) その他（具体的に指定）

2. 入力方法はどうしますか？
   A) コマンドライン引数（例: python calc.py 10 20）
   B) 対話的に入力を求める
   C) ファイルから読み込む（CSV、テキストなど）
   D) GUIを表示する

3. 出力形式は？
   A) コンソールに表示
   B) ファイルに保存
   C) 両方

4. エラーハンドリングは？
   A) 基本的なエラー処理（例: ゼロ除算）
   B) 詳細なエラーメッセージとロギング
   C) なし

5. その他の要件はありますか？
   - テストコードは必要ですか？
   - ドキュメントは必要ですか？

----------------------------------------------------------------------
質問に回答してください。
コマンド: 'execute'=実行, 'cancel'=中止
----------------------------------------------------------------------

Airis> (対話中) 1はA、2はB、3はA、4はB、テストコードとドキュメントも必要です

【分析】
ありがとうございます。要件が明確になりました。

【最終仕様】
- 機能: 四則演算（足し算、引き算、掛け算、割り算）
- 入力方法: 対話的（ユーザーにプロンプトで入力を求める）
- 出力形式: コンソールに表示
- エラーハンドリング: 詳細なエラーメッセージとロギング
- テストコード: 含む（pytestを使用）
- ドキュメント: 含む（README.mdと関数ドキュメント）

【実装内容】
1. calculator.py - メインプログラム
   - add(), subtract(), multiply(), divide() 関数
   - main() 関数で対話的に入力を受け付ける
   - 詳細なエラーメッセージ
   
2. test_calculator.py - テストコード
   - 各関数のユニットテスト
   - エッジケースのテスト
   
3. README.md - ドキュメント
   - 使い方の説明
   - 関数の説明

【実装準備完了】
この仕様で実装を開始できます。

以下のコマンドを選択してください：
- 'execute' または '実行': この仕様で実装を開始
- 'modify' または '修正': 仕様を修正
- 'cancel' または 'キャンセル': 中止

Airis> (対話中) execute

要件に基づいて実行しました。

======================================================================
実行結果:
======================================================================
# Calculator Implementation

[生成されたコード...]

--- VALIDATION ---
✓ 検証完了: 品質基準を満たしています
【理由】: すべての要件が満たされ、テストコードとドキュメントも含まれています

Airis> 
```

### 3.2 データベース管理システムの設計

```
Airis> interactive データベース管理システムを設計して

======================================================================
対話モードを開始します...
======================================================================

【分析】
データベース管理システムの設計リクエストです。多くの要素を明確にする必要があります。

【確認事項】
1. どの種類のデータベースですか？
   A) SQLite（軽量、ファイルベース）
   B) PostgreSQL（本格的なRDBMS）
   C) MongoDB（NoSQL）
   D) その他

2. 主な機能は？
   A) CRUD操作のみ（Create, Read, Update, Delete）
   B) 検索とフィルタリング
   C) トランザクション管理
   D) すべて

3. ユースケースは？
   - どのようなデータを管理しますか？
   - 想定ユーザー数は？

4. セキュリティ要件は？
   A) SQLインジェクション対策必須
   B) 認証・認可機能
   C) 暗号化
   D) 特になし

5. パフォーマンス要件は？
   - データ量の想定は？
   - レスポンスタイム要件は？

Airis> (対話中) 1はA、2はA、ユースケースは個人のタスク管理、セキュリティは基本的な対策、パフォーマンスは小規模で問題なし

[続く...]
```

---

## 4. コマンドリファレンス

### 4.1 対話モード専用コマンド

| コマンド | 説明 | 例 |
|---------|------|-----|
| `interactive <リクエスト>` | 対話モード開始 | `interactive Webアプリを作って` |
| `対話 <リクエスト>` | 対話モード開始（日本語） | `対話 APIサーバーを作って` |
| `execute` | 要件確定後に実行 | `execute` |
| `実行` | 要件確定後に実行（日本語） | `実行` |
| `modify` | 仕様を修正 | `modify` |
| `修正` | 仕様を修正（日本語） | `修正` |
| `cancel` | 対話を中止 | `cancel` |
| `キャンセル` | 対話を中止（日本語） | `キャンセル` |

### 4.2 一般コマンド

| コマンド | 説明 | 例 |
|---------|------|-----|
| `quick <リクエスト>` | クイック実行（要件確認なし） | `quick web search: AI trends` |
| `project create <名前>` | プロジェクト作成 | `project create my_app` |
| `project use <名前>` | プロジェクト切り替え | `project use my_app` |
| `project list` | プロジェクト一覧 | `project list` |
| `ai engine info` | AI設定表示 | `ai engine info` |
| `help` | ヘルプ表示 | `help` |
| `history` | コマンド履歴 | `history` |
| `clear` | 画面クリア | `clear` |
| `exit` / `quit` | 終了 | `exit` |

---

## 5. 対話モードのフロー

### 5.1 要件収集フェーズ

```
ユーザー: 初期リクエスト
    ↓
Airis: 分析 + 確認事項（3-5個の質問）
    ↓
ユーザー: 回答
    ↓
Airis: 追加確認事項 or 要件確定
    ↓
（繰り返し）
    ↓
Airis: 【要件確定】最終仕様
    ↓
ユーザー: execute
    ↓
実行
```

### 5.2 修正フェーズ

```
Airis: 【要件確定】...

ユーザー: modify
    ↓
Airis: どの部分を修正しますか？
    ↓
ユーザー: 入力方法をファイルから読み込むに変更
    ↓
Airis: 【修正完了】修正された仕様
    ↓
ユーザー: execute
    ↓
実行
```

---

## 6. 高度な使用例

### 6.1 複雑なプロジェクトの立ち上げ

```
Airis> interactive Webアプリケーションのプロジェクトを立ち上げたい

【分析】
Webアプリケーションプロジェクトの立ち上げには、多くの技術的決定が必要です。

【確認事項】
1. フロントエンドフレームワークは？
   A) React
   B) Vue.js
   C) Vanilla JavaScript
   D) その他

2. バックエンドフレームワークは？
   A) Flask（Python）
   B) Django（Python）
   C) Express（Node.js）
   D) その他

3. データベースは？
   A) SQLite
   B) PostgreSQL
   C) MongoDB
   D) 不要

4. 認証機能は必要ですか？
   A) はい（JWT）
   B) はい（セッションベース）
   C) いいえ

5. デプロイ環境は？
   A) Docker
   B) Heroku
   C) AWS
   D) ローカルのみ

Airis> (対話中) [回答...]

[要件が詰まった後、プロジェクト構造、設定ファイル、
 ボイラープレートコードを自動生成]
```

### 6.2 APIの設計

```
Airis> interactive RESTful APIを設計したい

【確認事項】
1. APIの目的は？
   - どのようなデータを扱いますか？
   - 主な機能は？

2. エンドポイント数の想定は？
   A) 5個以下（シンプル）
   B) 5-20個（中規模）
   C) 20個以上（大規模）

3. 認証方式は？
   A) API Key
   B) OAuth 2.0
   C) JWT
   D) 不要

4. ドキュメント形式は？
   A) OpenAPI/Swagger
   B) Markdown
   C) 不要

5. レート制限は必要ですか？

Airis> (対話中) [回答...]

[要件確定後、OpenAPI仕様、実装コード、
 テストコード、ドキュメントを生成]
```

---

## 7. 対話モードと従来モードの比較

| 項目 | 対話モード | クイックモード（従来） |
|------|----------|-------------------|
| **起動方法** | `python -m airis.main` | `python -m airis.main "prompt"` |
| **要件確認** | あり（複数ターン） | なし（即実行） |
| **実行速度** | 遅い（会話が必要） | 速い |
| **精度** | 高い（要件が明確） | 低い（曖昧な指示の場合） |
| **適用場面** | 複雑なタスク、新規開発 | 単純なタスク、既知の操作 |
| **ユーザー体験** | インタラクティブ | バッチ処理的 |

---

## 8. 対話モードの内部動作

### 8.1 セッション管理

```python
class InteractiveSession:
    conversation_history: List[Dict]  # 会話履歴
    requirements_gathered: bool       # 要件確定フラグ
    final_specification: Dict         # 最終仕様
```

### 8.2 会話フロー

```
1. start_session(initial_prompt)
   - 初期プロンプトを分析
   - 確認事項を生成
   - 最初の質問を返す

2. continue_conversation(user_response)
   - ユーザーの回答を受け取る
   - 会話履歴に追加
   - 次の質問 or 要件確定を判断

3. get_final_prompt()
   - 収集した要件から最終プロンプトを生成
   - Orchestratorに渡すための最適化

4. execute()
   - 最終プロンプトでタスク実行
   - 検証実施
   - 結果返却
```

---

## 9. 設定

### 9.1 対話モードの有効化

対話モードはデフォルトで有効です。無効化する場合：

```yaml
# config.yaml

# Interactive mode settings
enable_interactive_mode: false  # 無効化
```

### 9.2 質問数の調整

```yaml
# config.yaml

interactive_mode:
  max_questions_per_turn: 5     # 1ターンあたりの最大質問数
  max_conversation_turns: 10    # 最大会話ターン数
  auto_execute_threshold: 0.9   # 要件明確度がこの値以上で自動実行
```

---

## 10. ベストプラクティス

### 10.1 対話モードを使うべき場合

✅ **新規プロジェクトの立ち上げ**
   - 要件が複雑
   - 技術選定が必要

✅ **複雑なコード生成**
   - 多くの機能が必要
   - エッジケースの処理が重要

✅ **設計タスク**
   - アーキテクチャ設計
   - API設計

✅ **初めて使う機能**
   - どのような出力が得られるか不明
   - オプションを確認したい

### 10.2 クイックモードを使うべき場合

⚡ **単純なタスク**
   - Web検索
   - ファイル操作
   - 既知のパターン

⚡ **繰り返しタスク**
   - 同じ形式のコード生成
   - 定型的なドキュメント生成

⚡ **急ぎの場合**
   - すぐに結果が欲しい
   - 要件が明確

---

## 11. トラブルシューティング

### 11.1 対話が途中で止まる

**症状**: Airisが応答しなくなる

**原因**:
- LLM APIのタイムアウト
- ネットワークエラー

**解決方法**:
```bash
# セッションをリセット
Airis> (対話中) cancel
Airis> interactive [もう一度リクエスト]
```

### 11.2 質問が多すぎる

**症状**: 細かい質問が延々と続く

**原因**: LLMが過度に詳細を求めている

**解決方法**:
```bash
# 一括で回答
Airis> (対話中) デフォルト設定でOKです。標準的な実装でお願いします。

# または、クイックモードに切り替え
Airis> (対話中) cancel
Airis> quick [詳細な指示を含むリクエスト]
```

### 11.3 要件が確定しない

**症状**: 何度回答しても要件確定にならない

**原因**: 回答が曖昧

**解決方法**:
```bash
# 明確に指示
Airis> (対話中) 今までの回答で要件確定して実装を開始してください
```

---

## 12. 対話モードの拡張

### 12.1 現在の実装（v2.2.0）

- ✅ 基本的な対話フロー
- ✅ 要件収集と確定
- ✅ 会話履歴の管理
- ✅ セッション管理

### 12.2 将来の拡張（Phase 3以降）

#### A. 自動改善ループ
```
要件確定
    ↓
実装
    ↓
検証NG検出
    ↓
自動的に要件を修正
    ↓
再実装
    ↓
検証OK
```

#### B. マルチモーダル対話
- 画像をアップロードして「このようなUIを作って」
- 音声入力での対話
- 図表を見せて「このアーキテクチャを実装して」

#### C. コンテキスト保持
- 過去の対話を記憶
- 「前回と同じ設定で」が使える
- ユーザーの好みを学習

---

## 13. 使用シナリオ

### シナリオ1: 初心者ユーザー

```
ユーザー: Pythonでゲームを作りたい

Airis: どのようなゲームですか？
       A) じゃんけん
       B) 数当てゲーム
       C) その他

ユーザー: じゃんけんで

Airis: GUIは必要ですか？
       A) コマンドラインで十分
       B) Tkinterで簡単なGUI
       C) Pygameで本格的なGUI

ユーザー: コマンドラインで

Airis: 対戦相手は？
       A) コンピューター（ランダム）
       B) 2人対戦
       C) コンピューター（AI戦略）

ユーザー: コンピューターで

[要件確定 → 実装]
```

### シナリオ2: 上級ユーザー

```
ユーザー: RESTful APIを作って、FastAPI使用、
         PostgreSQL接続、JWT認証、
         Dockerコンテナで動作、
         OpenAPI仕様自動生成

Airis: 【分析】
       詳細な指示をありがとうございます。
       いくつか確認させてください。
       
       1. データモデルは？
       2. エンドポイントの詳細は？
       3. CORS設定は？

ユーザー: [回答...]

[最小限の確認で要件確定]
```

---

## 14. パフォーマンスとコスト

### 14.1 対話モードのコスト

- **会話ターン**: 平均3-5ターン
- **LLM呼び出し**: ターンごとに1回
- **トークン数**: 1ターンあたり1,000-3,000トークン
- **推定コスト**: $0.01-0.05 per conversation

### 14.2 時間

- **要件収集**: 1-3分（ユーザー入力含む）
- **実装**: 10-60秒
- **検証**: 5-10秒
- **合計**: 2-5分

従来のワンライナーより時間はかかりますが、成果物の品質が大幅に向上します。

---

## 15. まとめ

対話モードにより、Airisは：

1. **要件の明確化**: ユーザーと会話して詳細を詰める
2. **精度の向上**: 曖昧さを排除して正確な実装
3. **ユーザー体験**: 自然な会話で使いやすい
4. **柔軟性**: 途中で修正や変更が可能

これにより、Airisはより人間のアシスタントに近い存在になります。

---

## 付録A: 対話モードの起動方法（詳細）

### A.1 Dockerコンテナ内で対話モード

```bash
# 1. コンテナに入る
$ docker-compose run --rm airis bash

# 2. 対話モードを起動
$ python3 -m airis.main

# 3. 使用開始
Airis> interactive 機械学習モデルを作って
```

### A.2 ホストから直接起動

```bash
# docker-compose.ymlのコマンドを変更
$ docker-compose run --rm airis python3 -m airis.main --interactive
```

### A.3 永続的な対話モード

```bash
# コンテナを永続化
$ docker-compose up -d
$ docker exec -it airis_app python3 -m airis.main -i
```

---

## 付録B: カスタマイズ例

### B.1 質問スタイルのカスタマイズ

`airis/interactive_mode.py`の`clarification_prompt`を編集：

```python
clarification_prompt = f"""あなたはフレンドリーなアシスタントです。

ユーザーのリクエスト: {initial_prompt}

楽しく、わかりやすく質問してください！

質問:
1. (カジュアルな質問)
2. ...
"""
```

### B.2 自動実行モード

要件が80%以上明確なら自動実行：

```python
# config.yaml
interactive_mode:
  auto_execute: true
  clarity_threshold: 0.8
```

